# Full local development stack
# Usage: docker-compose -f docker-compose.yaml -f docker-compose.local.yaml up

services:
  redis:
    image: redis:7-alpine
    expose:
      - "6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  verifier:
    build:
      context: ../../
      dockerfile: infra/docker/Dockerfile.verifier
    expose:
      - "8081"
    environment:
      - NODE_ENV=development
      - VERIFIER_PORT=8081
      - REDIS_URL=redis://redis:6379
      - OB_TRUSTED_DIRECTORIES=
      - OB_MAX_SKEW_SEC=300
      - OB_NONCE_TTL_SEC=600
    depends_on:
      redis:
        condition: service_healthy

  # Override proxy to use local verifier
  proxy:
    environment:
      - OBA_VERIFIER_URL=http://verifier:8081/verify
    depends_on:
      demo-backend:
        condition: service_healthy
      verifier:
        condition: service_started
